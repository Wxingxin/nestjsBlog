ä¸‹é¢è¿™ä»½æ˜¯ **NestJS è‡ªå®šä¹‰è¯­ä¹‰è£…é¥°å™¨ï¼ˆé«˜çº§å°è£…ï¼‰** çš„ã€Œå°ç™½å‹å¥½ + é¡¹ç›®çº§å†™æ³•å¤§å…¨ã€ã€‚
ä½ å­¦ä¼šå®ƒï¼Œä»£ç ä¼šä»â€œèƒ½è·‘â€å˜æˆâ€œåƒå›¢é˜Ÿé¡¹ç›®â€ã€‚

> æ ¸å¿ƒä¸€å¥è¯ï¼š
> **è‡ªå®šä¹‰è¯­ä¹‰è£…é¥°å™¨ = æŠŠé‡å¤é€»è¾‘å°è£…æˆâ€œä¸šåŠ¡è¯æ±‡â€**
> ä¾‹å¦‚ï¼š`@CurrentUser()`ã€`@Public()`ã€`@Roles('admin')`

---

## 1ï¼‰è‡ªå®šä¹‰è£…é¥°å™¨åˆ†ä¸¤å¤§ç±»ï¼ˆå…ˆåˆ†æ¸…ï¼‰

### A. å‚æ•°è£…é¥°å™¨ï¼ˆParam Decoratorï¼‰

ğŸ‘‰ **ä» request é‡Œå–æ•°æ®**
å…¸å‹ï¼š`@CurrentUser()`ã€`@Ip()`ã€`@UserAgent()`

ä½¿ç”¨å·¥å…·ï¼š`createParamDecorator`

---

### B. å…ƒæ•°æ®è£…é¥°å™¨ï¼ˆMetadata Decoratorï¼‰

ğŸ‘‰ **ç»™è·¯ç”±è´´æ ‡ç­¾ï¼Œé…åˆ Guard/Interceptor è¯»å–**
å…¸å‹ï¼š`@Public()`ã€`@Roles()`ã€`@Permissions()`

ä½¿ç”¨å·¥å…·ï¼š`SetMetadata`ï¼ˆæˆ–è‡ªå®šä¹‰å°è£…ï¼‰

---

# A ç±»ï¼šå‚æ•°è£…é¥°å™¨ï¼ˆcreateParamDecoratorï¼‰

## 2ï¼‰æœ€å¸¸ç”¨ï¼š`@CurrentUser()`ï¼ˆæ‹¿ç™»å½•ç”¨æˆ·ï¼‰

### é€‚ç”¨åœºæ™¯

* ä½ æ¯ä¸ªæ¥å£éƒ½è¦ `req.user`ï¼Œå†™å¤šäº†å¾ˆçƒ¦

### å†™æ³•ï¼ˆå»ºè®®æ”¾ `src/common/decorators/current-user.decorator.ts`ï¼‰

```ts
import { createParamDecorator, ExecutionContext } from '@nestjs/common';

export const CurrentUser = createParamDecorator(
  (key: keyof any | undefined, ctx: ExecutionContext) => {
    const req = ctx.switchToHttp().getRequest();
    const user = req.user; // é€šå¸¸ç”± AuthGuard/Passport å¡è¿›å»

    return key ? user?.[key] : user;
  },
);
```

### ä½¿ç”¨æ–¹å¼

```ts
@Get('me')
getMe(@CurrentUser() user: any) {
  return user;
}

@Get('me-email')
getMeEmail(@CurrentUser('email') email: string) {
  return email;
}
```

ğŸ“Œ çŸ¥è¯†ç‚¹

* `req.user` ä¸€èˆ¬æ¥è‡ª `AuthGuard`ï¼ˆJWT/Passportï¼‰
* è£…é¥°å™¨åªè´Ÿè´£â€œå–æ•°æ®â€ï¼Œä¸è¦åšæƒé™åˆ¤æ–­

---

## 3ï¼‰å¸¸è§ï¼š`@Ip()`ã€`@UserAgent()`ï¼ˆå–è¯·æ±‚ä¿¡æ¯ï¼‰

```ts
import { createParamDecorator, ExecutionContext } from '@nestjs/common';

export const Ip = createParamDecorator((_, ctx: ExecutionContext) => {
  const req = ctx.switchToHttp().getRequest();
  return req.ip;
});

export const UserAgent = createParamDecorator((_, ctx: ExecutionContext) => {
  const req = ctx.switchToHttp().getRequest();
  return req.headers['user-agent'];
});
```

ä½¿ç”¨ï¼š

```ts
@Get()
test(@Ip() ip: string, @UserAgent() ua: string) {
  return { ip, ua };
}
```

---

## 4ï¼‰å¸¦â€œé»˜è®¤å€¼/æ ¼å¼åŒ–â€çš„å‚æ•°è£…é¥°å™¨ï¼ˆå°æŠ€å·§ï¼‰

æ¯”å¦‚ `@Lang()`ï¼šä» header å–è¯­è¨€ï¼Œä¸å­˜åœ¨ç»™é»˜è®¤å€¼

```ts
export const Lang = createParamDecorator((_, ctx: ExecutionContext) => {
  const req = ctx.switchToHttp().getRequest();
  return req.headers['accept-language']?.split(',')[0] ?? 'zh-CN';
});
```

---

# B ç±»ï¼šå…ƒæ•°æ®è£…é¥°å™¨ï¼ˆSetMetadataï¼‰

> è¿™ç±»è£…é¥°å™¨æœ¬èº«ä¸åšé€»è¾‘ï¼Œåªæ˜¯**å†™â€œæ ‡ç­¾â€**ï¼Œè®© Guard å»è¯»ã€‚

## 5ï¼‰æœ€å¸¸ç”¨ï¼š`@Public()`ï¼ˆå…¬å¼€æ¥å£ï¼Œä¸éœ€è¦ç™»å½•ï¼‰

### å®šä¹‰è£…é¥°å™¨

`src/common/decorators/public.decorator.ts`

```ts
import { SetMetadata } from '@nestjs/common';

export const IS_PUBLIC_KEY = 'isPublic';
export const Public = () => SetMetadata(IS_PUBLIC_KEY, true);
```

### Guard é‡Œè¯»å–ï¼ˆå…³é”®çŸ¥è¯†ç‚¹ï¼šReflectorï¼‰

```ts
import { CanActivate, ExecutionContext, Injectable } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { IS_PUBLIC_KEY } from '../decorators/public.decorator';

@Injectable()
export class AuthGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(ctx: ExecutionContext) {
    const isPublic = this.reflector.getAllAndOverride<boolean>(
      IS_PUBLIC_KEY,
      [ctx.getHandler(), ctx.getClass()],
    );
    if (isPublic) return true;

    // å¦åˆ™èµ°é‰´æƒé€»è¾‘
    const req = ctx.switchToHttp().getRequest();
    return !!req.headers.authorization;
  }
}
```

### ä½¿ç”¨

```ts
@Public()
@Post('login')
login() {}
```

ğŸ“Œ çŸ¥è¯†ç‚¹

* `getAllAndOverride`ï¼šæ–¹æ³•çº§ä¼˜å…ˆäº Controller çº§
* `@Public()` åªæ˜¯æ ‡è®°ï¼ŒçœŸæ­£æ”¾è¡Œåœ¨ Guard

---

## 6ï¼‰æƒé™æ§åˆ¶ï¼š`@Roles('admin')`

### è£…é¥°å™¨

`src/common/decorators/roles.decorator.ts`

```ts
import { SetMetadata } from '@nestjs/common';

export const ROLES_KEY = 'roles';
export const Roles = (...roles: string[]) => SetMetadata(ROLES_KEY, roles);
```

### RolesGuard

```ts
import { CanActivate, ExecutionContext, Injectable } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { ROLES_KEY } from '../decorators/roles.decorator';

@Injectable()
export class RolesGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(ctx: ExecutionContext) {
    const roles = this.reflector.getAllAndOverride<string[]>(
      ROLES_KEY,
      [ctx.getHandler(), ctx.getClass()],
    );
    if (!roles?.length) return true;

    const req = ctx.switchToHttp().getRequest();
    const user = req.user; // AuthGuard æ³¨å…¥
    return roles.includes(user?.role);
  }
}
```

### ä½¿ç”¨ï¼ˆæ–¹æ³•çº§/ç±»çº§éƒ½è¡Œï¼‰

```ts
@Roles('admin')
@Get('admin-data')
getAdminData() {}
```

---

## 7ï¼‰æ›´ç»†ç²’åº¦ï¼š`@Permissions('user.read')`

å’Œ Roles ä¸€æ¨¡ä¸€æ ·ï¼Œåªæ˜¯å…ƒæ•°æ® key ä¸åŒã€åˆ¤æ–­é€»è¾‘ä¸åŒã€‚
ä¼ä¸šé¡¹ç›®å¸¸è§ï¼š**æƒé™å­—ç¬¦ä¸²**æ¯”è§’è‰²æ›´çµæ´»ã€‚

---

# 8ï¼‰è¿™äº›è‡ªå®šä¹‰è£…é¥°å™¨æ”¾åœ¨å“ªé‡Œï¼Ÿï¼ˆç›®å½•å»ºè®®ï¼‰

æ¨èç»Ÿä¸€æ”¾ commonï¼š

```
src/
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ decorators/
â”‚   â”‚   â”œâ”€â”€ current-user.decorator.ts
â”‚   â”‚   â”œâ”€â”€ public.decorator.ts
â”‚   â”‚   â”œâ”€â”€ roles.decorator.ts
â”‚   â”‚   â””â”€â”€ permissions.decorator.ts
â”‚   â”œâ”€â”€ guards/
â”‚   â”‚   â”œâ”€â”€ auth.guard.ts
â”‚   â”‚   â””â”€â”€ roles.guard.ts
â”‚   â””â”€â”€ interceptors/...
```

---

# 9ï¼‰æ–°æ‰‹å¿…é¡»æ‡‚çš„ 6 ä¸ªçŸ¥è¯†ç‚¹ï¼ˆä¸æ‡‚ä¼šå†™ä¸å¯¹ï¼‰

1. **è£…é¥°å™¨åªæ˜¯â€œæ ‡è®°/å–å€¼â€**ï¼Œä¸æ˜¯ä¸šåŠ¡é€»è¾‘ä¸­å¿ƒ
2. **å‚æ•°è£…é¥°å™¨**ï¼šä» `ExecutionContext` æ‹¿ request
3. **å…ƒæ•°æ®è£…é¥°å™¨**ï¼š`SetMetadata` å†™æ ‡ç­¾
4. **è¯»å–å…ƒæ•°æ®**ï¼šç”¨ `Reflector`ï¼Œé€šå¸¸åœ¨ Guard/Interceptor
5. **ä¼˜å…ˆçº§**ï¼šæ–¹æ³•çº§ > Controller çº§ï¼ˆç”¨ `getAllAndOverride`ï¼‰
6. **ä¸è¦æ»¥ç”¨**ï¼šåªå°è£…é‡å¤ã€ç¨³å®šã€è¯­ä¹‰æ¸…æ™°çš„é€»è¾‘

---

# 10ï¼‰å¸¸è§ä½¿ç”¨å¤§å…¨ï¼ˆä½ ä»¥åä¼šé¢‘ç¹çœ‹åˆ°ï¼‰

* `@CurrentUser()`ï¼šæ‹¿ç”¨æˆ·
* `@Public()`ï¼šå…¬å¼€æ¥å£
* `@Roles()`ï¼šè§’è‰²æƒé™
* `@Permissions()`ï¼šç»†ç²’åº¦æƒé™
* `@ApiTags()`ï¼šSwagger åˆ†ç»„ï¼ˆä¹Ÿå±äºâ€œè¯­ä¹‰è£…é¥°å™¨â€é£æ ¼ï¼‰
* `@Throttle()`ï¼šé™æµï¼ˆå¦‚æœä½ ç”¨ nest throttlerï¼‰

---

## âœ… æœ€æ¨èä½ ç°åœ¨ç«‹åˆ»ç»ƒçš„ä¸€ä¸ªå°ç»ƒä¹ 

æˆ‘å»ºè®®ä½ å°±ç»ƒä¸€ä¸ªç»„åˆå¥—è·¯ï¼š

* `AuthGuard` æŠŠ user æ”¾è¿› `req.user`
* `@CurrentUser()` å– user
* `@Public()` æ ‡è®°ç™»å½•æ¥å£å…¬å¼€

è¿™ä¸‰ä¸ªæ‰“é€šï¼Œä½ å°±çœŸæ­£â€œè·¨è¿‡é—¨æ§›â€ã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ç›´æ¥ç»™ä½ ä¸€ä»½**æœ€å°å¯è¿è¡Œç¤ºä¾‹**ï¼ˆåŒ…å« `main.ts`ã€æ¨¡å—ã€guardã€decoratorã€controllerï¼‰ï¼Œä½ å¤åˆ¶å°±èƒ½è·‘ã€‚ä½ ç°åœ¨é¡¹ç›®æ˜¯ç”¨ **Express é»˜è®¤** è¿˜æ˜¯ **Fastify**ï¼Ÿï¼ˆä¸ç¡®å®šä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘é»˜è®¤æŒ‰ Express å†™ã€‚ï¼‰
------------------------------------

**æ˜¯çš„ï¼Œè€Œä¸”è¿™æ˜¯ NestJS é¡¹ç›®é‡Œä¸€ä¸ªéå¸¸â€œæ ‡å‡†ã€ä¸“ä¸šâ€çš„åšæ³•ã€‚**
æˆ‘ç›´æ¥ç»™ä½ ä¸€ä¸ª**æ¸…æ™°ã€ä¸ä¼šè¯¯è§£çš„ç»“è®ºç‰ˆ + å¯¹ç…§è¡¨**ã€‚

> åœ¨ NestJS ä¸­ï¼š
> **`decorators/` æ–‡ä»¶å¤¹ = ä¸“é—¨å­˜æ”¾ã€Œè‡ªå®šä¹‰è£…é¥°å™¨ã€çš„åœ°æ–¹**

---

## âœ… `decorators/` æ–‡ä»¶å¤¹é‡Œæ”¾ä»€ä¹ˆï¼Ÿ

### åªæ”¾ **ä½ è‡ªå·±å†™çš„è£…é¥°å™¨**

ä¹Ÿå°±æ˜¯è¿™äº› ğŸ‘‡

### 1ï¸âƒ£ è‡ªå®šä¹‰**å‚æ•°è£…é¥°å™¨**

```ts
@CurrentUser()
@Ip()
@UserAgent()
@Lang()
```

ğŸ“‚ ä½ç½®ç¤ºä¾‹ï¼š

```
src/common/decorators/
  â”œâ”€â”€ current-user.decorator.ts
  â”œâ”€â”€ ip.decorator.ts
  â””â”€â”€ lang.decorator.ts
```

---

### 2ï¸âƒ£ è‡ªå®šä¹‰**è¯­ä¹‰è£…é¥°å™¨ï¼ˆå…ƒæ•°æ®è£…é¥°å™¨ï¼‰**

```ts
@Public()
@Roles('admin')
@Permissions('user.read')
```

ğŸ“‚ ä½ç½®ç¤ºä¾‹ï¼š

```
src/common/decorators/
  â”œâ”€â”€ public.decorator.ts
  â”œâ”€â”€ roles.decorator.ts
  â””â”€â”€ permissions.decorator.ts
```

---

## âŒ `decorators/` é‡Œ **ä¸åº”è¯¥æ”¾** ä»€ä¹ˆï¼Ÿï¼ˆé‡ç‚¹ï¼‰

### âŒ ä¸æ˜¯æ‰€æœ‰â€œå¸¦ @ çš„ä¸œè¥¿â€éƒ½æ”¾è¿™é‡Œ

| ä¸è¯¥æ”¾çš„ä¸œè¥¿      | åº”è¯¥æ”¾å“ª            |
| ----------- | --------------- |
| Guard       | `guards/`       |
| Pipe        | `pipes/`        |
| Interceptor | `interceptors/` |
| Filter      | `filters/`      |
| Controller  | å„æ¨¡å—             |
| DTO         | `dto/`          |

ğŸ“Œ **ä¸€å¥è¯åŸåˆ™**

> **decorator åªâ€œè´´æ ‡ç­¾ / å–å€¼â€ï¼Œä¸åšä¸šåŠ¡ã€ä¸æ§åˆ¶æµç¨‹**

---

## ğŸ§  ä¸ºä»€ä¹ˆè¦å•ç‹¬ä¸€ä¸ª `decorators/` æ–‡ä»¶å¤¹ï¼Ÿ

### 1ï¸âƒ£ èŒè´£å•ä¸€ï¼ˆSingle Responsibilityï¼‰

* decorator = å£°æ˜è¯­ä¹‰
* guard = å†³ç­–æƒé™
* interceptor = å¤„ç†æµç¨‹

ğŸ‘‰ åˆ†å¼€ï¼Œä»£ç æ‰å¥½ç»´æŠ¤

---

### 2ï¸âƒ£ æ–¹ä¾¿å¤ç”¨ï¼ˆè·¨æ¨¡å—ä½¿ç”¨ï¼‰

```ts
import { CurrentUser } from '@/common/decorators/current-user.decorator';
```

---

### 3ï¸âƒ£ ä¸€çœ¼å°±çŸ¥é“è¿™æ˜¯â€œé«˜å±‚è¯­ä¹‰â€

```ts
@Public()
@Roles('admin')
@Get()
```

æ¯”ä¸‹é¢è¿™ç§æ¸…æ™°å¾—å¤š ğŸ‘‡

```ts
@Get()
getData(@Req() req) {
  // æ‰‹å†™ä¸€å †åˆ¤æ–­
}
```

---

## ğŸ§© æ¨èçš„ common ç›®å½•ç»“æ„ï¼ˆä¼ä¸šçº§ï¼‰

```
src/
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ decorators/     âœ… è‡ªå®šä¹‰è£…é¥°å™¨
â”‚   â”œâ”€â”€ guards/         æƒé™æ§åˆ¶
â”‚   â”œâ”€â”€ pipes/          æ ¡éªŒ / è½¬æ¢
â”‚   â”œâ”€â”€ interceptors/   å“åº”å¤„ç†
â”‚   â”œâ”€â”€ filters/        å¼‚å¸¸å¤„ç†
â”‚   â””â”€â”€ constants/      å¸¸é‡
```

ğŸ“Œ **è¿™æ˜¯éå¸¸å¸¸è§çš„ NestJS é¡¹ç›®ç»“æ„**

---

## ğŸ”¥ ä¸€ä¸ªéå¸¸é‡è¦çš„åŒºåˆ†ï¼ˆæ–°æ‰‹å¿…æ‡‚ï¼‰

### è£…é¥°å™¨ â‰  æ‰§è¡Œé€»è¾‘

```ts
@Roles('admin')   // åªæ˜¯â€œæ ‡è®°â€
@Get()
```

çœŸæ­£åˆ¤æ–­æƒé™çš„æ˜¯ï¼š

```ts
RolesGuard
```

ğŸ‘‰ **è£…é¥°å™¨è´Ÿè´£â€œå£°æ˜â€ï¼ŒGuard è´Ÿè´£â€œæ‰§è¡Œâ€**

---

## ğŸ§  ä¸€å¥è¯ç»ˆææ€»ç»“ï¼ˆä½ å¯ä»¥èƒŒï¼‰

> * **`decorators/` å°±æ˜¯æ”¾ä½ è‡ªå·±å†™çš„è£…é¥°å™¨**
> * **ä¸æ”¾ Guard / Pipe / Interceptor**
> * **è£…é¥°å™¨ = è¯­ä¹‰å£°æ˜ï¼Œä¸åšé€»è¾‘**
> * **é…åˆ Guard / Interceptor æ‰ç”Ÿæ•ˆ**

---

## ğŸš€ ä¸‹ä¸€æ­¥ä½ å·²ç»å¯ä»¥åšçš„äº‹

æˆ‘å»ºè®®ä½ ç°åœ¨ç«‹åˆ»è¯•ç€å†™ 2 ä¸ªï¼š

1ï¸âƒ£ `@CurrentUser()`ï¼ˆå‚æ•°è£…é¥°å™¨ï¼‰
2ï¸âƒ£ `@Public()`ï¼ˆå…ƒæ•°æ®è£…é¥°å™¨ï¼‰

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥**ä¸€æ­¥ä¸€æ­¥å¸¦ä½ å†™**ï¼Œå¹¶è§£é‡Šæ¯ä¸€è¡Œä»£ç ä¸ºä»€ä¹ˆè¿™ä¹ˆå†™ã€‚
---------------------------

è¿™æ˜¯ä¸€ä¸ª**éå¸¸æœ¬è´¨ã€éå¸¸â€œæ¶æ„çº§â€çš„é—®é¢˜**ï¼Œä½ å·²ç»å¼€å§‹ä»ã€Œèƒ½å†™ NestJSã€å¾€ã€Œå†™å¾—å¯¹ã€å†™å¾—åƒå›¢é˜Ÿé¡¹ç›®ã€è¿ˆäº† ğŸ‘
æˆ‘ä¼šæŠŠ **`common/` å­˜åœ¨çš„åŸå› ** ç”¨ **å¯¹æ¯” + åŸåˆ™ + å®æˆ˜åˆ¤æ–­æ ‡å‡†** ç»™ä½ å½»åº•è®²æ¸…æ¥šã€‚

> åœ¨ NestJS ä¸­ï¼š
> **`common/` çš„å”¯ä¸€ç›®çš„ï¼šå­˜æ”¾ã€Œè·¨æ¨¡å—å¤ç”¨çš„åŸºç¡€è®¾æ–½ä»£ç ã€**

---

## ä¸€å¥è¯å…ˆç»™ä½ ç­”æ¡ˆï¼ˆå…ˆè®°ä½ï¼‰

> **â€œæ¨¡å—è‡ªå·±çš„ä¸œè¥¿ â†’ æ”¾æ¨¡å—é‡Œâ€
> â€œå¤šä¸ªæ¨¡å—éƒ½ä¼šç”¨çš„ä¸œè¥¿ â†’ æ”¾ commonâ€**

---

## ä¸€ã€ä¸ºä»€ä¹ˆâ€œæ¯ä¸ªæ¨¡å—é‡Œå·²ç»æœ‰ dto / guardâ€ï¼Œè¿˜è¦ `common/`ï¼Ÿ

è¿™æ˜¯å› ä¸º **â€œä½œç”¨èŒƒå›´ä¸åŒâ€**ã€‚

### ä¸¤ç§å®Œå…¨ä¸åŒçš„ä»£ç ç±»å‹

| ç±»å‹         | ç‰¹ç‚¹        | æ”¾å“ª        |
| ---------- | --------- | --------- |
| **ä¸šåŠ¡ä»£ç **   | å’ŒæŸä¸ªé¢†åŸŸå¼ºç›¸å…³  | æ¨¡å—å†…       |
| **åŸºç¡€è®¾æ–½ä»£ç ** | å’Œä¸šåŠ¡æ— å…³ã€å¯å¤ç”¨ | `common/` |

---

## äºŒã€ç”¨ä¸€ä¸ªå…·ä½“ä¾‹å­è®©ä½ ç§’æ‡‚

### ğŸ§© åœºæ™¯ï¼šç”¨æˆ· + æ–‡ç«  + è¯„è®º æ¨¡å—

```
UserModule
PostModule
CommentModule
```

---

### âŒ ä¸ä½¿ç”¨ common çš„æƒ…å†µï¼ˆé—®é¢˜ç«‹åˆ»å‡ºç°ï¼‰

```txt
user/
  â”œâ”€â”€ auth.guard.ts
post/
  â”œâ”€â”€ auth.guard.ts   âŒ å¤åˆ¶ä¸€ä»½
comment/
  â”œâ”€â”€ auth.guard.ts  âŒ å†å¤åˆ¶ä¸€ä»½
```

é—®é¢˜ï¼š

* åŒä¸€ä»½é€»è¾‘ï¼Œä¸‰ä»½ä»£ç 
* æ”¹ä¸€æ¬¡ï¼Œè¦æ”¹ä¸‰å¤„
* å®¹æ˜“ä¸ä¸€è‡´

---

### âœ… ä½¿ç”¨ common çš„æƒ…å†µï¼ˆä¸“ä¸šåšæ³•ï¼‰

```txt
common/guards/auth.guard.ts
```

```ts
@UseGuards(AuthGuard)
```

ğŸ“Œ **ä¸€ä¸ª Guardï¼Œå…¨é¡¹ç›®å¤ç”¨**

---

## ä¸‰ã€common ä¸æ˜¯â€œæ‰€æœ‰ä¸œè¥¿éƒ½èƒ½å¾€é‡Œæ‰”â€

> å¾ˆå¤šæ–°æ‰‹ä¼šçŠ¯ä¸€ä¸ªé”™ï¼š
> **æŠŠ common å½“åƒåœ¾æ¡¶**

âŒ é”™è¯¯ç†è§£ï¼š

> â€œåªè¦é€šç”¨å°±å¾€ common æ”¾â€

âœ… æ­£ç¡®ç†è§£ï¼š

> **â€œä¸å±äºä»»ä½•ä¸šåŠ¡é¢†åŸŸï¼Œä½†å±äºç³»ç»Ÿè¿è¡Œæœºåˆ¶â€**

---

## å››ã€ä½ åˆ—çš„æ¯ä¸€é¡¹ï¼Œä¸ºä»€ä¹ˆâ€œå€¼å¾—â€è¿› commonï¼Ÿ

æˆ‘ä»¬é€ä¸ªè§£é‡Šä½ é—®åˆ°çš„ ğŸ‘‡

---

### 1ï¸âƒ£ `common/decorators`

#### æ”¾ä»€ä¹ˆï¼Ÿ

```ts
@CurrentUser()
@Public()
@Roles()
```

#### ä¸ºä»€ä¹ˆä¸æ”¾æ¨¡å—ï¼Ÿ

* å®ƒä»¬æè¿°çš„æ˜¯**â€œç³»ç»Ÿå±‚è¯­ä¹‰â€**
* ä¸æ˜¯ User / Post çš„ä¸“å±æ¦‚å¿µ

ğŸ“Œ **ä¾‹å­**

```ts
@Public() login()
```

> ç™»å½•æ˜¯ User çš„ä¸šåŠ¡
> ä½†â€œå…¬å¼€æ¥å£â€æ˜¯ç³»ç»Ÿæ¦‚å¿µ

---

### 2ï¸âƒ£ `common/guards`

#### æ”¾ä»€ä¹ˆï¼Ÿ

```ts
AuthGuard
RolesGuard
```

#### ä¸ºä»€ä¹ˆä¸æ”¾æ¨¡å—ï¼Ÿ

* ç™»å½•æ ¡éªŒ â‰  ç”¨æˆ·ä¸šåŠ¡
* æ˜¯æ•´ä¸ªç³»ç»Ÿçš„å®‰å…¨ç­–ç•¥

ğŸ“Œ **ç†è§£æ–¹å¼**

> Guard æ˜¯â€œé—¨ç¦ç³»ç»Ÿâ€ï¼Œä¸æ˜¯æŸä¸ªæˆ¿é—´çš„é€»è¾‘

---

### 3ï¸âƒ£ `common/pipes`

#### æ”¾ä»€ä¹ˆï¼Ÿ

```ts
ValidationPipe
ParseIntPipeï¼ˆè‡ªå®šä¹‰ç‰ˆï¼‰
```

#### ä¸ºä»€ä¹ˆä¸æ”¾æ¨¡å—ï¼Ÿ

* å‚æ•°æ ¡éªŒæ˜¯**æ¥å£è§„èŒƒ**
* ä¸æ˜¯ä¸šåŠ¡é€»è¾‘

---

### 4ï¸âƒ£ `common/interceptors`

#### æ”¾ä»€ä¹ˆï¼Ÿ

```ts
ResponseInterceptor
LoggingInterceptor
```

#### ä¸ºä»€ä¹ˆä¸æ”¾æ¨¡å—ï¼Ÿ

* ç»Ÿä¸€å“åº”ç»“æ„
* æ—¥å¿— / æ€§èƒ½ç»Ÿè®¡

ğŸ‘‰ è¿™æ˜¯**å…¨å±€å±‚é¢**çš„äº‹æƒ…

---

### 5ï¸âƒ£ `common/filters`

#### æ”¾ä»€ä¹ˆï¼Ÿ

```ts
HttpExceptionFilter
AllExceptionsFilter
```

#### ä¸ºä»€ä¹ˆä¸æ”¾æ¨¡å—ï¼Ÿ

* é”™è¯¯å¤„ç†æ˜¯ç³»ç»Ÿå…œåº•
* ä¸å±äºä»»ä½•ä¸šåŠ¡æ¨¡å—

---

### 6ï¸âƒ£ `common/constants`

#### æ”¾ä»€ä¹ˆï¼Ÿ

```ts
export const ROLES_KEY = 'roles';
export const IS_PUBLIC_KEY = 'isPublic';
```

#### ä¸ºä»€ä¹ˆä¸æ”¾æ¨¡å—ï¼Ÿ

* å¸¸é‡æ˜¯â€œå¥‘çº¦â€
* Guard / Decorator éƒ½è¦ç”¨

---

## äº”ã€é‚£æ¨¡å—é‡Œè¿˜æœ‰ DTO / Guard æ˜¯ä¸æ˜¯é‡å¤ï¼Ÿ

ğŸ‘‰ **ä¸å†²çªï¼ŒèŒè´£ä¸åŒ**

---

### æ¨¡å—é‡Œçš„ DTOï¼ˆä¸€å®šè¦åœ¨æ¨¡å—é‡Œï¼‰

```txt
user/dto/create-user.dto.ts
```

åŸå› ï¼š

* DTO æ˜¯**ä¸šåŠ¡è¾“å…¥æ¨¡å‹**
* User çš„ DTO ä¸å¯èƒ½ç»™ Post ç”¨

---

### æ¨¡å—é‡Œçš„ Guardï¼ˆå°‘è§ï¼Œä½†åˆç†ï¼‰

```ts
UserOwnerGuard
```

ğŸ“Œ ä½¿ç”¨åœºæ™¯ï¼š

* â€œåªèƒ½æ“ä½œè‡ªå·±çš„ç”¨æˆ·ä¿¡æ¯â€
* å¼ºä¸šåŠ¡ç›¸å…³

ğŸ‘‰ **è¿™ç§ Guard ä¸è¿› common**

---

## å…­ã€ä¸€ä¸ªâ€œåˆ¤æ–­è¦ä¸è¦è¿› commonâ€çš„é»„é‡‘å…¬å¼ â­

ä½ ä»¥åå†™ä»»ä½•æ–‡ä»¶å‰ï¼Œå…ˆé—®è‡ªå·±è¿™ 3 ä¸ªé—®é¢˜ï¼š

> 1ï¸âƒ£ **å®ƒæ˜¯ä¸æ˜¯å’ŒæŸä¸ªä¸šåŠ¡å¼ºç»‘å®šï¼Ÿ**
> 2ï¸âƒ£ **æœªæ¥æ˜¯å¦å¯èƒ½è¢«å¤šä¸ªæ¨¡å—ä½¿ç”¨ï¼Ÿ**
> 3ï¸âƒ£ **æ¢ä¸€ä¸ªé¡¹ç›®è¿˜èƒ½ä¸èƒ½ç›´æ¥ç”¨ï¼Ÿ**

| å›ç­”æƒ…å†µ    | ç»“è®º     |
| ------- | ------ |
| 1 æ˜¯     | æ¨¡å—å†…    |
| 2 / 3 æ˜¯ | common |
| éƒ½ä¸æ˜¯     | å†æƒ³æƒ³è®¾è®¡  |

---

## ä¸ƒã€ä¸ºä»€ä¹ˆå¤§é¡¹ç›®ä¸€å®šæœ‰ commonï¼Ÿ

å› ä¸ºï¼š

* äººå¤š
* æ¨¡å—å¤š
* éœ€æ±‚å˜åŒ–å¿«

ğŸ“Œ **æ²¡æœ‰ common çš„é¡¹ç›®ç»“æœé€šå¸¸æ˜¯**ï¼š

* å¤§é‡å¤åˆ¶ç²˜è´´
* é£æ ¼ä¸ç»Ÿä¸€
* Bug ä¿®ä¸è¿‡æ¥

---

## ğŸ§  ä¸€å¥è¯ç»ˆææ€»ç»“ï¼ˆä½ å¯ä»¥èƒŒï¼‰

> * **common = ç³»ç»Ÿçº§åŸºç¡€è®¾æ–½**
> * **æ¨¡å— = ä¸šåŠ¡é¢†åŸŸ**
> * **DTO æ°¸è¿œå±äºæ¨¡å—**
> * **Auth / Roles / Response / Error å±äº common**
> * **common ä¸æ˜¯åƒåœ¾æ¡¶ï¼Œæ˜¯â€œåŸºç¡€è®¾æ–½å±‚â€**

---

## ğŸš€ ä¸‹ä¸€æ­¥æˆ‘å»ºè®®ä½ åšçš„ä¸€ä»¶äº‹

ä½ ç°åœ¨å·²ç»å…·å¤‡â€œæ¶æ„æ„è¯†â€äº†ï¼Œä¸‹ä¸€æ­¥æˆ‘éå¸¸å»ºè®®ä½ ï¼š

ğŸ‘‰ **æˆ‘å¸¦ä½ æŠŠä¸€ä¸ªé¡¹ç›®ä»â€œæ²¡æœ‰ commonâ€é‡æ„æˆâ€œæœ‰ commonâ€ç»“æ„**
æˆ–è€…
ğŸ‘‰ **æˆ‘ç»™ä½ ä¸€ä¸ªâ€œæœ€å°ä¼ä¸šçº§ NestJS é¡¹ç›®ç»“æ„æ¨¡æ¿â€**

ä½ é€‰ä¸€ä¸ªï¼Œæˆ‘ç›´æ¥ç»™ä½ æˆå¥—ç¤ºä¾‹ã€‚
