下面把你这套 CRUD **升级为“DTO + class-validator 校验”**的标准写法：包含**新增依赖、main.ts 全局管道、DTO 改造（Create/Update）**，以及**常见错误返回效果**。代码都带注释，直接替换即可。

---

## 1）安装依赖（必须）

```bash
npm i class-validator class-transformer
```

* `class-validator`：提供 `@IsEmail()` / `@Length()` 等校验装饰器
* `class-transformer`：把请求体从 plain object 转成 DTO class（配合 ValidationPipe）

---

## 2）main.ts 开启全局 ValidationPipe（关键）

**路径：`src/main.ts`**（替换/补充为下面这样）

```ts
import { NestFactory } from '@nestjs/core'
import { AppModule } from './app.module'
import { ValidationPipe } from '@nestjs/common'

async function bootstrap() {
  const app = await NestFactory.create(AppModule)

  app.enableCors()

  /**
   * ✅ 全局校验管道：让 DTO 的 class-validator 生效
   */
  app.useGlobalPipes(
    new ValidationPipe({
      /**
       * ✅ whitelist=true：
       * 自动剔除 DTO 里没有定义的字段（防止前端乱传）
       */
      whitelist: true,

      /**
       * ✅ forbidNonWhitelisted=true：
       * 如果出现 DTO 未定义字段，直接报 400（更严格，更安全）
       */
      forbidNonWhitelisted: true,

      /**
       * ✅ transform=true：
       * 把请求体自动转换为 DTO 实例，同时也能做类型转换（配合 @Type）
       */
      transform: true,

      /**
       * ✅ transformOptions：
       * enableImplicitConversion=true：允许 “字符串转数字/布尔”等隐式转换（按需）
       */
      transformOptions: { enableImplicitConversion: true },
    }),
  )

  await app.listen(3000)
}
bootstrap()
```

> 你现在就拥有了“只允许 DTO 字段、类型可自动转换、非法字段直接报错”的企业级默认配置。

---

## 3）CreateUserDto：加入必备校验

**路径：`src/users/dto/create-user.dto.ts`**（替换为下面）

```ts
import { IsEmail, IsOptional, IsString, Length, Matches, IsUrl } from 'class-validator'

export class CreateUserDto {
  /**
   * ✅ 用户名：必须是字符串，长度 2~20
   * 可按你的产品规则加更严格的字符限制
   */
  @IsString({ message: 'username 必须是字符串' })
  @Length(2, 20, { message: 'username 长度必须在 2~20 之间' })
  // 例：只允许字母/数字/下划线（想要就打开）
  @Matches(/^[a-zA-Z0-9_]+$/, { message: 'username 只能包含字母/数字/下划线' })
  username: string

  /**
   * ✅ email：必须符合邮箱格式
   */
  @IsEmail({}, { message: 'email 格式不正确' })
  email: string

  /**
   * ✅ avatar：可选；如果传了，必须是 URL
   */
  @IsOptional()
  @IsUrl({}, { message: 'avatar 必须是有效的 URL' })
  avatar?: string
}
```

---

## 4）UpdateUserDto：部分更新 + 复用校验（推荐做法）

Update DTO 常见最佳实践：**PartialType(CreateUserDto)**
这样你不用重复写同样的校验规则。

**路径：`src/users/dto/update-user.dto.ts`**（替换为下面）

```ts
import { PartialType } from '@nestjs/mapped-types'
import { CreateUserDto } from './create-user.dto'

/**
 * ✅ PartialType：把 CreateUserDto 的所有字段变成可选（用于 PATCH）
 * 并且自动继承所有校验规则
 */
export class UpdateUserDto extends PartialType(CreateUserDto) {}
```

> 依赖：`@nestjs/mapped-types` 通常 Nest 项目自带；如果你这里报缺失，就安装：

```bash
npm i @nestjs/mapped-types
```

---

## 5）Controller 不用改（只要参数类型是 DTO 就会触发校验）

你现在的 Controller 写法保持不变即可：

```ts
@Post()
create(@Body() dto: CreateUserDto) {
  return this.usersService.create(dto)
}

@Patch(':id')
update(@Param('id') id: string, @Body() dto: UpdateUserDto) {
  return this.usersService.update(Number(id), dto)
}
```

---

## 6）校验失败时会返回什么（你测试一下就懂）

### ✅ 示例 1：username 太短

请求：

```http
POST /users
{
  "username": "a",
  "email": "wjx@test.com"
}
```

响应（400）会类似：

```json
{
  "statusCode": 400,
  "message": [
    "username 长度必须在 2~20 之间"
  ],
  "error": "Bad Request"
}
```

### ✅ 示例 2：多传字段（whitelist + forbidNonWhitelisted）

请求：

```http
POST /users
{
  "username": "wjx",
  "email": "wjx@test.com",
  "role": "admin"
}
```

响应（400）会提示非法字段 `role`（更安全）。

---

## 7）你下一步很该做的两个“必备增强”（我建议你直接要）

1. **Param 的 id 校验**：`ParseIntPipe`（避免 `Number(id)` 变 NaN）
2. **更好看的错误格式**：自定义 `exceptionFactory`（把 message 变成字段级错误对象）

你回我一句：**“加上 id 的 ParseIntPipe + 统一错误格式”**
我就把 controller/service 的改法也完整贴出来（同样带注释）。
