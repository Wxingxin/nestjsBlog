ä¸‹é¢æˆ‘**æŒ‰çœŸå® NestJS é¡¹ç›®é‡Œæœ€æ ‡å‡†ã€æœ€å¸¸ç”¨çš„æ–¹å¼**ï¼Œç³»ç»Ÿè®²æ¸…æ¥šï¼š

> **AuthGuard æ˜¯ä»€ä¹ˆ â†’ CanActivate æ€ä¹ˆå†™ â†’ é‡Œé¢ä¸€èˆ¬å†™ä»€ä¹ˆ â†’ åœ¨å“ªé‡Œå¼•å…¥ / æ€ä¹ˆç”¨ â†’ å¸¸è§è¿›é˜¶ç”¨æ³•**

ä¸ç©æŠ½è±¡ï¼Œå…¨éƒ¨è´´**å¯ç›´æ¥ç”¨çš„ä»£ç **ã€‚

---

# ä¸€ã€AuthGuard æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿï¼ˆä¸€å¥è¯ï¼‰

> **AuthGuard = è·¯ç”±å‰çš„â€œé—¨ç¦â€**
> è¯·æ±‚ â†’ Guard â†’ Controller
> âŒ ä¸é€šè¿‡ï¼šç›´æ¥ 401 / 403
> âœ… é€šè¿‡ï¼šæ‰ä¼šè¿›å…¥ Controller

å®ƒ**åªè´Ÿè´£â€œèƒ½ä¸èƒ½è¿›â€**ï¼Œä¸è´Ÿè´£ä¸šåŠ¡ã€‚

---

# äºŒã€æœ€åŸºç¡€ç»“æ„ï¼ˆä½ é—®çš„è¿™ä¸ªï¼‰

```ts
@Injectable()
export class AuthGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    return true
  }
}
```

ä½†çœŸå®é¡¹ç›®é‡Œï¼Œ`canActivate` **å‡ ä¹ä¸€å®šæ˜¯ async çš„**ã€‚

---

# ä¸‰ã€ä¸€ä¸ªâ€œæ ‡å‡† JWT é‰´æƒ AuthGuardâ€ï¼ˆæœ€å¸¸è§ï¼‰

## 1ï¸âƒ£ AuthGuard å®Œæ•´ç¤ºä¾‹ï¼ˆæ ¸å¿ƒï¼‰

**è·¯å¾„å»ºè®®ï¼š`src/auth/guards/auth.guard.ts`**

```ts
import {
  Injectable,
  CanActivate,
  ExecutionContext,
  UnauthorizedException,
} from '@nestjs/common'
import { JwtService } from '@nestjs/jwt'
import { Request } from 'express'

@Injectable()
export class AuthGuard implements CanActivate {
  constructor(
    private readonly jwtService: JwtService, // âœ… æ³¨å…¥ JwtService
  ) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    /**
     * 1ï¸âƒ£ æ‹¿åˆ°å½“å‰è¯·æ±‚å¯¹è±¡
     * HTTP / GraphQL / RPC éƒ½èƒ½é€‚é…
     */
    const request = context.switchToHttp().getRequest<Request>()

    /**
     * 2ï¸âƒ£ ä»è¯·æ±‚å¤´å– token
     * Authorization: Bearer xxx
     */
    const authHeader = request.headers['authorization']
    if (!authHeader) {
      throw new UnauthorizedException('æœªæºå¸¦ Authorization')
    }

    const [type, token] = authHeader.split(' ')
    if (type !== 'Bearer' || !token) {
      throw new UnauthorizedException('Authorization æ ¼å¼é”™è¯¯')
    }

    /**
     * 3ï¸âƒ£ æ ¡éªŒ token
     */
    try {
      const payload = await this.jwtService.verifyAsync(token)

      /**
       * 4ï¸âƒ£ æŠŠç”¨æˆ·ä¿¡æ¯æŒ‚åˆ° request ä¸Š
       * åé¢çš„ controller / service éƒ½å¯ä»¥ç”¨
       */
      request['user'] = payload

      return true
    } catch (err) {
      throw new UnauthorizedException('token æ— æ•ˆæˆ–å·²è¿‡æœŸ')
    }
  }
}
```

---

## 2ï¸âƒ£ ä¸ºä»€ä¹ˆè¦ `request.user = payload`ï¼Ÿ

å› ä¸ºä½ åé¢**ä¸€å®šä¼šç”¨**ï¼š

```ts
@Get('profile')
getProfile(@Req() req) {
  return req.user
}
```

è¿™æ˜¯ NestJS ç”Ÿæ€é‡Œçš„**çº¦å®šä¿—æˆ**ã€‚

---

# å››ã€AuthModuleï¼šGuard ä¾èµ–åœ¨å“ªé‡Œå¼•å…¥ï¼Ÿ

### 1ï¸âƒ£ AuthModuleï¼ˆå¿…é¡»ï¼‰

**è·¯å¾„ï¼š`src/auth/auth.module.ts`**

```ts
import { Module } from '@nestjs/common'
import { JwtModule } from '@nestjs/jwt'

@Module({
  imports: [
    JwtModule.register({
      secret: 'jwt-secret',       // å®é™…é¡¹ç›®è¯·æ”¾ env
      signOptions: { expiresIn: '7d' },
    }),
  ],
  providers: [
    // AuthGuard ä¸ä¸€å®šæ”¾è¿™é‡Œï¼ˆçœ‹ä½ æ€ä¹ˆç”¨ï¼‰
  ],
  exports: [JwtModule], // âœ… è®©å…¶ä»–æ¨¡å—ä¹Ÿèƒ½ç”¨ JwtService
})
export class AuthModule {}
```

---

### 2ï¸âƒ£ åœ¨ AppModule / ä¸šåŠ¡ Module å¼•å…¥ AuthModule

```ts
@Module({
  imports: [AuthModule, UsersModule],
})
export class AppModule {}
```

---

# äº”ã€AuthGuard åœ¨å“ªé‡Œâ€œç”¨â€ï¼Ÿï¼ˆ3 ç§å¸¸è§æ–¹å¼ï¼‰

---

## âœ… ç”¨æ³• 1ï¼šå•ä¸ªè·¯ç”±ä½¿ç”¨ï¼ˆæœ€å¸¸è§ï¼‰

```ts
@UseGuards(AuthGuard)
@Get('profile')
getProfile(@Req() req) {
  return req.user
}
```

ğŸ“Œ **ä¼˜ç‚¹**ï¼šçµæ´»
ğŸ“Œ **ç¼ºç‚¹**ï¼šè¦å†™å¾ˆå¤šæ¬¡

---

## âœ… ç”¨æ³• 2ï¼šController çº§åˆ«ä½¿ç”¨

```ts
@UseGuards(AuthGuard)
@Controller('users')
export class UsersController {
  @Get()
  findAll() {}
}
```

ğŸ“Œ æ•´ä¸ª Controller éƒ½éœ€è¦ç™»å½•

---

## âœ… ç”¨æ³• 3ï¼šå…¨å±€ Guardï¼ˆä¼ä¸šçº§ï¼‰

### å†™æ³•ä¸€ï¼ˆä¸æ¨èï¼Œä¸èƒ½æ³¨å…¥ä¾èµ–ï¼‰

```ts
app.useGlobalGuards(new AuthGuard())
```

### âœ… æ­£ç¡®å†™æ³•ï¼ˆæ¨èï¼‰

**åœ¨ AppModule é‡Œæ³¨å†Œ**

```ts
import { APP_GUARD } from '@nestjs/core'

@Module({
  providers: [
    {
      provide: APP_GUARD,
      useClass: AuthGuard,
    },
  ],
})
export class AppModule {}
```

ğŸ“Œ **ç‰¹ç‚¹**ï¼š

* æ‰€æœ‰æ¥å£é»˜è®¤éœ€è¦ç™»å½•
* å¯ä»¥é…åˆ `@Public()` è£…é¥°å™¨æ”¾è¡Œ

---

# å…­ã€å¦‚ä½•åšâ€œç™½åå• / @Public() è·¯ç”±â€ï¼ˆéå¸¸å¸¸è§ï¼‰

## 1ï¸âƒ£ è‡ªå®šä¹‰è£…é¥°å™¨

**`src/auth/decorators/public.decorator.ts`**

```ts
import { SetMetadata } from '@nestjs/common'

export const IS_PUBLIC_KEY = 'isPublic'
export const Public = () => SetMetadata(IS_PUBLIC_KEY, true)
```

---

## 2ï¸âƒ£ Guard ä¸­è¯»å– metadata

```ts
import { Reflector } from '@nestjs/core'

@Injectable()
export class AuthGuard implements CanActivate {
  constructor(
    private jwtService: JwtService,
    private reflector: Reflector,
  ) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    /**
     * âœ… å¦‚æœæ˜¯ Public è·¯ç”±ï¼Œç›´æ¥æ”¾è¡Œ
     */
    const isPublic = this.reflector.getAllAndOverride<boolean>(
      IS_PUBLIC_KEY,
      [context.getHandler(), context.getClass()],
    )

    if (isPublic) return true

    // â¬‡ï¸ å¦åˆ™ç»§ç»­èµ° token æ ¡éªŒé€»è¾‘
  }
}
```

---

## 3ï¸âƒ£ ä½¿ç”¨

```ts
@Public()
@Post('login')
login() {}
```

---

# ä¸ƒã€AuthGuard å¸¸è§æ‰©å±•ç‚¹ï¼ˆä½ ä»¥åä¸€å®šä¼šç”¨ï¼‰

| åœºæ™¯         | æ€ä¹ˆåš                                              |
| ---------- | ------------------------------------------------ |
| è§’è‰²æƒé™       | `@Roles('admin') + RolesGuard`                   |
| å¤š token ç±»å‹ | Access / Refresh Guard åˆ†å¼€                        |
| GraphQL    | `context.switchToHttp()` â†’ `GqlExecutionContext` |
| å¾®æœåŠ¡        | `context.switchToRpc()`                          |
| æ¥å£é™æµ       | é…åˆ `ThrottlerGuard`                              |

---

# å…«ã€æœ€é‡è¦çš„ 3 å¥è¯ï¼ˆå¸®ä½ è®°ç‰¢ï¼‰

1ï¸âƒ£ **Guard åªåšâ€œèƒ½ä¸èƒ½è¿›â€**ï¼Œä¸å†™ä¸šåŠ¡
2ï¸âƒ£ **ä¾èµ–æ³¨å…¥ â†’ Module å†³å®š Guard èƒ½ä¸èƒ½ç”¨**
3ï¸âƒ£ **å…¨å±€ Guard + @Public() = æœ€ä¼˜è§£**

---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ ï¼š

* âœ… å†™ä¸€å¥— **å®Œæ•´ç™»å½• / æ³¨å†Œ / JWT å‘æ”¾æµç¨‹**
* âœ… æ‹† **AccessToken / RefreshToken åŒ Token Guard**
* âœ… å†™ **RolesGuardï¼ˆRBACï¼‰**
* âœ… æŠŠ Guard + Filter + Interceptor ç»Ÿä¸€æˆä¸€å¥—â€œä¼ä¸šæ¨¡æ¿â€

ä½ åªè¦è¯´ä¸€å¥ï¼š**â€œä¸‹ä¸€æ­¥åš JWT ç™»å½•å®Œæ•´æµç¨‹â€** æˆ– **â€œåšè§’è‰²æƒé™â€** å³å¯ã€‚
