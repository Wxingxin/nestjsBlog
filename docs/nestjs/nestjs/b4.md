下面把你要的两件事一次性补齐，并且是**NestJS 项目里最常见、最“企业级默认”的写法**：

1. `@Param('id', ParseIntPipe)`：避免 `Number(id)` 变 `NaN`
2. `ValidationPipe + exceptionFactory`：把校验错误从数组消息变成**字段级错误对象**

---

# 1）Param 的 id 校验：ParseIntPipe

## ✅ 改 Controller（推荐：每个 id 路由都用）

**路径：`src/users/users.controller.ts`**（把涉及 id 的三个接口改掉）

```ts
import {
  Controller,
  Get,
  Post,
  Patch,
  Delete,
  Param,
  Body,
  ParseIntPipe, // ✅ 新增：把 id 解析成 number，并自动做合法性校验
} from '@nestjs/common'
import { UsersService } from './users.service'
import { CreateUserDto } from './dto/create-user.dto'
import { UpdateUserDto } from './dto/update-user.dto'

@Controller('users')
export class UsersController {
  constructor(private readonly usersService: UsersService) {}

  @Post()
  create(@Body() dto: CreateUserDto) {
    return this.usersService.create(dto)
  }

  @Get()
  findAll() {
    return this.usersService.findAll()
  }

  @Get(':id')
  findOne(
    // ✅ ParseIntPipe：把 "1" -> 1；把 "abc" 直接 400
    @Param('id', ParseIntPipe) id: number,
  ) {
    return this.usersService.findOne(id)
  }

  @Patch(':id')
  update(
    @Param('id', ParseIntPipe) id: number,
    @Body() dto: UpdateUserDto,
  ) {
    return this.usersService.update(id, dto)
  }

  @Delete(':id')
  remove(@Param('id', ParseIntPipe) id: number) {
    return this.usersService.remove(id)
  }
}
```

### ✅ 效果

* `/users/123` ✅ id=123
* `/users/abc` ❌ 直接 400（不会进 service）

---

# 2）更好看的错误格式：自定义 exceptionFactory

目标：把默认这种

```json
{
  "message": ["username 长度必须在 2~20 之间", "email 格式不正确"]
}
```

变成字段级：

```json
{
  "code": "VALIDATION_ERROR",
  "message": "Validation failed",
  "errors": {
    "username": ["username 长度必须在 2~20 之间"],
    "email": ["email 格式不正确"]
  }
}
```

## ✅ 修改 main.ts：给 ValidationPipe 加 exceptionFactory

**路径：`src/main.ts`**（把你的 ValidationPipe 换成下面这个版本）

```ts
import { NestFactory } from '@nestjs/core'
import { AppModule } from './app.module'
import { BadRequestException, ValidationPipe } from '@nestjs/common'
import type { ValidationError } from 'class-validator'

/**
 * ✅ 把 class-validator 的 ValidationError[] 转成字段级错误对象
 */
function formatValidationErrors(errors: ValidationError[]) {
  const result: Record<string, string[]> = {}

  const traverse = (err: ValidationError, parentPath = '') => {
    // property：字段名；constraints：当前字段的错误；children：嵌套 DTO 的错误
    const fieldPath = parentPath ? `${parentPath}.${err.property}` : err.property

    if (err.constraints) {
      result[fieldPath] = Object.values(err.constraints)
    }

    // ✅ 处理嵌套 DTO（例如 profile.name 这种）
    if (err.children && err.children.length) {
      for (const child of err.children) traverse(child, fieldPath)
    }
  }

  for (const e of errors) traverse(e)
  return result
}

async function bootstrap() {
  const app = await NestFactory.create(AppModule)

  app.enableCors()

  app.useGlobalPipes(
    new ValidationPipe({
      whitelist: true,             // ✅ 剔除 DTO 未声明字段
      forbidNonWhitelisted: true,  // ✅ 多传字段直接报错
      transform: true,             // ✅ plain -> DTO 实例

      /**
       * ✅ 自定义异常工厂：把校验错误包装成你想要的结构
       */
      exceptionFactory: (errors: ValidationError[]) => {
        return new BadRequestException({
          code: 'VALIDATION_ERROR',
          message: 'Validation failed',
          errors: formatValidationErrors(errors),
        })
      },
    }),
  )

  await app.listen(3000)
}
bootstrap()
```

---

# 3）你会看到的实际返回（例子）

### 例 1：username 不符合正则 + email 非法

请求：

```http
POST /users
Content-Type: application/json

{
  "username": "a!",
  "email": "not-email"
}
```

返回（400）：

```json
{
  "code": "VALIDATION_ERROR",
  "message": "Validation failed",
  "errors": {
    "username": ["username 长度必须在 2~20 之间", "username 只能包含字母/数字/下划线"],
    "email": ["email 格式不正确"]
  }
}
```

### 例 2：id 非数字

```http
GET /users/abc
```

返回（400，来自 ParseIntPipe）一般是：

```json
{
  "statusCode": 400,
  "message": "Validation failed (numeric string is expected)",
  "error": "Bad Request"
}
```

> 如果你也想把 **ParseIntPipe 的错误** 统一成你上面的结构，需要加一个全局 ExceptionFilter（下一步我可以给你完整代码）。

---

# 4）可选：让 ParseIntPipe 报错更友好（同样字段化）

如果你想 `/users/abc` 返回更可控信息，可以这样写（仍在 Controller）：

```ts
@Param(
  'id',
  new ParseIntPipe({ errorHttpStatusCode: 400 }),
) id: number
```

但真正“统一格式”的方案是全局 Filter。

---

如果你愿意继续升级，我建议下一步做 **“全局异常过滤器”**（统一 `ParseIntPipe`、`NotFoundException`、`ConflictException` 等所有错误响应结构），这样你的 API 返回就完全一致了。你回我：**“加全局 ExceptionFilter 统一所有错误格式”** 我就给你一套可直接用的。
