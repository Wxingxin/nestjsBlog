ä¸‹é¢æˆ‘æŒ‰ **â€œçœŸå® NestJS ä¼ä¸šé¡¹ç›®â€** çš„æ–¹å¼ï¼ŒæŠŠ **ResponseInterceptorï¼ˆå“åº”æ‹¦æˆªå™¨ï¼‰** è®²æ¸…æ¥šï¼š

> **å®ƒæ˜¯å¹²å˜›çš„ â†’ æ€ä¹ˆå†™ â†’ èƒ½æ‹¦ä»€ä¹ˆ â†’ æ€ä¹ˆé…ç½® â†’ åœ¨å“ªé‡Œå¼•å…¥ â†’ å¸¸è§é«˜çº§ç”¨æ³•**

æ‰€æœ‰ä»£ç **å¯ç›´æ¥å¤åˆ¶ä½¿ç”¨**ã€‚

---

# ä¸€ã€ResponseInterceptor æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ

ä¸€å¥è¯ï¼š

> **ç»Ÿä¸€åŒ…è£… Controller çš„è¿”å›ç»“æœ**

æ²¡æœ‰æ‹¦æˆªå™¨æ—¶ï¼š

```json
{
  "id": 1,
  "username": "wjx"
}
```

æœ‰æ‹¦æˆªå™¨åï¼š

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": 1,
    "username": "wjx"
  }
}
```

ğŸ“Œ **ç‰¹ç‚¹**

* åªå¤„ç† **æˆåŠŸå“åº”**
* ä¸å¤„ç†å¼‚å¸¸ï¼ˆå¼‚å¸¸äº¤ç»™ ExceptionFilterï¼‰

---

# äºŒã€æœ€åŸºç¡€ç»“æ„ï¼ˆä½ é—®çš„è¿™ä¸ªï¼‰

```ts
@Injectable()
export class ResponseInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler) {
    return next.handle()
  }
}
```

ä½†çœŸå®é¡¹ç›®é‡Œä¸€å®šä¼šé…åˆ `rxjs`ã€‚

---

# ä¸‰ã€ä¸€ä¸ªâ€œæ ‡å‡†å“åº”åŒ…è£… ResponseInterceptorâ€ï¼ˆæ¨èç›´æ¥ç”¨ï¼‰

## 1ï¸âƒ£ ResponseInterceptor å®Œæ•´å®ç°

**è·¯å¾„å»ºè®®ï¼š`src/common/interceptors/response.interceptor.ts`**

```ts
import {
  Injectable,
  NestInterceptor,
  ExecutionContext,
  CallHandler,
} from '@nestjs/common'
import { Observable } from 'rxjs'
import { map } from 'rxjs/operators'

@Injectable()
export class ResponseInterceptor implements NestInterceptor {
  intercept(
    context: ExecutionContext,
    next: CallHandler,
  ): Observable<any> {
    /**
     * next.handle() = Controller è¿”å›çš„æ•°æ®æµ
     */
    return next.handle().pipe(
      map((data) => {
        return {
          code: 0,
          message: 'success',
          data,
        }
      }),
    )
  }
}
```

---

# å››ã€åœ¨å“ªé‡Œâ€œå¼•å…¥â€ ResponseInterceptorï¼Ÿï¼ˆ3 ç§æ–¹å¼ï¼‰

---

## âœ… ç”¨æ³• 1ï¼šå•ä¸ªè·¯ç”±ä½¿ç”¨

```ts
@UseInterceptors(ResponseInterceptor)
@Get('profile')
getProfile() {
  return { username: 'wjx' }
}
```

ğŸ“Œ **ä¼˜ç‚¹**ï¼šç²¾ç¡®æ§åˆ¶
ğŸ“Œ **ç¼ºç‚¹**ï¼šé‡å¤å†™

---

## âœ… ç”¨æ³• 2ï¼šController çº§åˆ«ä½¿ç”¨

```ts
@UseInterceptors(ResponseInterceptor)
@Controller('users')
export class UsersController {
  @Get()
  findAll() {}
}
```

ğŸ“Œ æ•´ä¸ª Controller éƒ½èµ°ç»Ÿä¸€å“åº”ç»“æ„

---

## âœ… ç”¨æ³• 3ï¼šå…¨å±€æ‹¦æˆªå™¨ï¼ˆæœ€æ¨èï¼‰

### âŒ é”™è¯¯å†™æ³•ï¼ˆæ— æ³•æ³¨å…¥ä¾èµ–ï¼‰

```ts
app.useGlobalInterceptors(new ResponseInterceptor())
```

### âœ… æ­£ç¡®å†™æ³•ï¼ˆæ”¯æŒä¾èµ–æ³¨å…¥ï¼‰

**åœ¨ AppModule é‡Œæ³¨å†Œ**

```ts
import { APP_INTERCEPTOR } from '@nestjs/core'
import { ResponseInterceptor } from './common/interceptors/response.interceptor'

@Module({
  providers: [
    {
      provide: APP_INTERCEPTOR,
      useClass: ResponseInterceptor,
    },
  ],
})
export class AppModule {}
```

ğŸ“Œ **æ•ˆæœ**ï¼š
æ‰€æœ‰ Controller çš„æˆåŠŸå“åº”éƒ½ä¼šè¢«ç»Ÿä¸€åŒ…è£…ã€‚

---

# äº”ã€ResponseInterceptor é‡Œå¸¸è§â€œé«˜çº§é…ç½®â€

## 1ï¸âƒ£ è·³è¿‡æŸäº›æ¥å£ï¼ˆä¾‹å¦‚æ–‡ä»¶ä¸‹è½½ / Webhookï¼‰

### æ–¹æ¡ˆï¼šè‡ªå®šä¹‰è£…é¥°å™¨ `@Raw()`

#### è£…é¥°å™¨

```ts
// src/common/decorators/raw.decorator.ts
import { SetMetadata } from '@nestjs/common'

export const RAW_RESPONSE_KEY = 'rawResponse'
export const Raw = () => SetMetadata(RAW_RESPONSE_KEY, true)
```

#### æ‹¦æˆªå™¨ä¸­è¯»å–

```ts
import { Reflector } from '@nestjs/core'

@Injectable()
export class ResponseInterceptor implements NestInterceptor {
  constructor(private reflector: Reflector) {}

  intercept(context: ExecutionContext, next: CallHandler) {
    const isRaw = this.reflector.getAllAndOverride<boolean>(
      RAW_RESPONSE_KEY,
      [context.getHandler(), context.getClass()],
    )

    if (isRaw) {
      return next.handle() // ä¸åŒ…è£…
    }

    return next.handle().pipe(
      map((data) => ({
        code: 0,
        message: 'success',
        data,
      })),
    )
  }
}
```

#### ä½¿ç”¨

```ts
@Raw()
@Get('download')
download() {
  return fs.createReadStream('a.zip')
}
```

---

## 2ï¸âƒ£ å¤„ç†åˆ†é¡µç»“æ„ï¼ˆå¸¸è§ï¼‰

```ts
map((data) => {
  if (data?.items && data?.meta) {
    return {
      code: 0,
      message: 'success',
      data: data.items,
      meta: data.meta,
    }
  }

  return { code: 0, message: 'success', data }
})
```

---

## 3ï¸âƒ£ è¯»å– HTTP çŠ¶æ€ç  / è¯·æ±‚ä¿¡æ¯

```ts
const ctx = context.switchToHttp()
const response = ctx.getResponse()
const request = ctx.getRequest()

const statusCode = response.statusCode
const url = request.url
```

å¯ç”¨äºæ—¥å¿—ã€åŸ‹ç‚¹ã€‚

---

# å…­ã€ResponseInterceptor vs Filter vs Guardï¼ˆåˆ«æ··ï¼‰

| èƒ½åŠ›     | Guard | Interceptor | Filter |
| ------ | ----- | ----------- | ------ |
| æ˜¯å¦ç™»å½•   | âœ…     | âŒ           | âŒ      |
| ä¿®æ”¹è¿”å›æ•°æ® | âŒ     | âœ…           | âŒ      |
| æ•è·å¼‚å¸¸   | âŒ     | âŒ           | âœ…      |
| åŒ…è£…æˆåŠŸå“åº” | âŒ     | âœ…           | âŒ      |

---

# ä¸ƒã€ä½ ç°åœ¨è¿™å¥—â€œä¼ä¸šçº§é»˜è®¤ä¸‰ä»¶å¥—â€

ä½ ç°åœ¨å·²ç»æ‹¥æœ‰ï¼š

* âœ… **AuthGuard**ï¼šé‰´æƒ
* âœ… **ResponseInterceptor**ï¼šç»Ÿä¸€æˆåŠŸå“åº”
* âœ… **ValidationPipe + exceptionFactory**ï¼šç»Ÿä¸€å‚æ•°é”™è¯¯

åªå·®æœ€åä¸€æ­¥ï¼š

> **å…¨å±€ ExceptionFilterï¼ˆç»Ÿä¸€æ‰€æœ‰å¼‚å¸¸å“åº”æ ¼å¼ï¼‰**

è¿™æ ·ä½ çš„æ¥å£è¿”å›å°† **100% ä¸€è‡´**ã€‚

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥ç»™ä½ ä¸€å¥— **ExceptionFilter + é”™è¯¯ç è§„èŒƒ**ï¼Œä½ å¯ä»¥ç›´æ¥ä½œä¸ºé¡¹ç›®æ¨¡æ¿ç”¨ã€‚
